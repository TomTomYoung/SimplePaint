# ベクターツールアーキテクチャ評価

本ドキュメントは、明確化された目標に照らして提案されたベクターツールアーキテクチャを再評価します：ベクターツール自体が再利用可能な `VectorLayer` に委譲する代わりに、すべてのベクター状態を所有する必要があります。以下のノートは、改訂された計画が SimplePaint の慣例とどのように整合するか、その利点、シフトによって導入された新しいリスク、そして次に必要な具体的なステップをキャプチャします。

## 既存のエンジン＆ストアパターンとの整合性

- **ツール中心の状態**: `makeVectorTool` 内で制御データを保持することは、既存のブラシが進行中のストロークを追跡する方法を反映しています。ベクターツールは、ラスタライズやエクスポートが必要な場合にのみエンジンにコミットされるプライベートなインメモリモデル（パス、アンカー、選択）を保持でき、追加のレイヤー抽象化を回避できます。
- **エンジン統合**: ツールから直接 `engine.beginStrokeSnapshot()`/`finishStrokeToHistory()` を呼び出すことで、現在の Undo/Redo との互換性が維持されます。ベクターツールは、ベクターデータをベイクすることを決定したときにラスタライズされたスナップショットを渡すだけで、他のツールの期待と一致します。
- **ストア使用**: 永続化される設定（スナップトグル、簡略化許容値、ラスタライズモード）は共有ストア内のツールスライスにスコープされたままなので、マニフェストの変更は不要です。

## ツール所有アプローチの強み

1. **より小さな表面積**: `VectorLayer` を削除することで、横断的な依存関係が排除されます。ツールはそのデータ構造をカプセル化し、アプリの残りの部分が理解する必要がある API フットプリントを削減します。
2. **よりシンプルなライフサイクル管理**: 選択と編集の状態がポインターハンドラと一緒に存在するため、レイヤーサブシステムとツール UI の間で選択を調整する必要がありません。
3. **より高速な実験**: パス編集動作の反復はツールコードのみに影響するため、コアエンジンモジュールをリファクタリングせずに迅速なプロトタイピングが可能です。
4. **同じ機能の豊富さ**: 座標プロセッサ（スナッピング、Douglas–Peucker 簡略化）、レンダラー（プレビューオーバーレイ）、ラスタライザモード、SVG エクスポートは、ツールが所有する内部ヘルパーとして引き続き保持されます。

## リスク＆オープンクエスチョン

- **状態の永続化**: 共有レイヤーがなければ、長寿命のベクターデータがどのように保存されるかを決定する必要があります。オプションには、ツール内に内部履歴スタックを保持するか、ベクターコマンドをエンジン履歴エントリにシリアライズして、リロード後も Undo が機能するようにすることが含まれます。
- **既存の選択 UI との連携**: ツールは選択ハイライトを所有するようになりました。競合するキューを避けるために、グローバル選択クロムがいつ非表示にされるか再利用されるかの規則が必要です。
- **ツール内データ構造のパフォーマンス**: ツール内で JavaScript ですべてのベクターパスを管理すると、ドキュメントが複雑になった場合にメモリに影響を与える可能性があります。プロファイリングで、エンジンレベルの共有なしでデータ構造が効率的であることを確認する必要があります。
- **ラスター履歴の忠実度**: 自動ラスタライズは引き続き履歴差分と統合する必要があります。ツールがトリガーする `finishStrokeToHistory()` 呼び出しが、ラスタースナップショットと編集用にベクター状態を再構築するのに十分なメタデータの両方をキャプチャすることを検証する必要があります。

## 推奨される次のステップ

1. 内部モデル（パス + アンカー）を持つ `makeVectorTool` をプロトタイプ化し、別のレイヤーに依存せずにポインターイベントフローを検証します。
2. ヘルパーモジュール（`CoordinateProcessor`、`VectorRenderer`、`VectorRasterizer`）がツールによって呼び出されるプライベートユーティリティとして純粋に動作するようにコントラクトを定義します。
3. 特に `auto` ラスタライズモードで、ツール所有の履歴がセッション間で一貫していることを確認するための Undo/Redo 実験を実装します。
4. 既存のサイドバーコントロールでツール管理設定（スナップトグル、簡略化許容値、ラスタライズモード）を公開するための UX 仕様を作成します。

ツール所有の方向性を今文書化することで、その後の実装が SimplePaint の現在のアーキテクチャに焦点を当て、互換性を維持できるようになります。
