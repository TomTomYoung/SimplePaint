# SimplePaint アーキテクチャ概要

SimplePaint は4つのレイヤーで構成されています：レンダリングコア、共有ユーティリティ、インタラクティブツール、そして `index.html` で公開されるプレゼンテーションレイヤーです。アーキテクチャは意図的にモジュラー設計されており、ツールや拡張機能を個別に開発し、マニフェストシステムを通じて登録できます。

## 1. レンダリングコア

`src/core/` に配置されており、レンダリングコアは状態、履歴、描画オーケストレーションを管理します。

- **`engine.js`** – キャンバスコンテキストをラップし、ツール実行パイプラインを提供し、Undo/Redo のための `HistoryManager` を統合します。
- **`store.js`** – Zustand にインスパイアされた軽量なオブザーバブルストア。派生サブスクリプション用の `watch` ヘルパーを公開します。
- **`viewport.js`** – スクリーン座標とキャンバス座標の変換、ズーム・パンをサポートします。
- **`layer.js`** – 描画可能なレイヤーとその描画順序を記述します。
- **`event-bus.js`** – ユーザーインタラクションとツールイベント用の集中型 pub/sub。

## 2. ツールシステム

ツールは `src/tools/` 配下にあり、カテゴリごとにグループ化されています。各ツールは、エンジンが期待するライフサイクルハンドラ（`onPointerDown`、`onPointerMove`、`onPointerUp`、`drawPreview` など）を返すファクトリ関数をエクスポートします。

マニフェスト（`src/tools/base/manifest.js`）は宣言的なカタログを提供します。レジストリ（`src/tools/base/registry.js`）は、各ツール ID が一意であり、ランタイムで取得可能であることを保証します。ツールはエンジン内部に触れることなく交換や拡張が可能です。

## 3. ユーティリティ

`src/utils/` ディレクトリには共有機能が格納されています：

- `canvas/` – フレームバッファヘルパーと合成ユーティリティ。
- `geometry/` – ベクトル計算、交差判定、曲線ヘルパー。
- `image/processing.js` – ラスターツール用のブラー、シャープ、畳み込み。
- `color-space.js` – 変換とカラーブレンディングヘルパー。
- `math/` – イージングカーブ、ノイズジェネレーター、統計。
- `path.js` – ポリライン、ベジェ、ストロークアウトライン操作。

## 4. プレゼンテーションレイヤー

`index.html` はエンジンをブートストラップし、デフォルトのツールマニフェストを読み込み、UI コントロールを接続します。スタイリングは `styles.css` にあります。このレイヤーは意図的に薄く設計されており、ほとんどの動作はエンジンとツールにカプセル化されているため、将来の UI 書き換えが容易になります。

## データフロー

1. ユーザーインタラクションが DOM イベントをトリガーします。
2. イベントはエンジンに転送され、レジストリを介して現在のツールを検索します。
3. ツールハンドラがストアを変更するか、スクラッチキャンバスに描画します。
4. エンジンが結果をアクティブレイヤーにコミットし、履歴エントリを記録します。
5. ビューポートとプレゼンテーションレイヤーがストアの変更に応答し、必要に応じて再レンダリングします。

## 拡張性

- **新しいツールの追加** は、適切なカテゴリにモジュールを作成し、マニフェストに登録することで行います。
- **カスタム状態の注入** は、追加のスライスとウォッチャーでストアを拡張することで行います。
- **イベントのリッスン** は、イベントバスを介してオーバーレイやコラボレーション機能を構築します。

## テスト戦略

コアモジュールは決定論的であり、関数を直接インポートしてユニットテストできます。ツールの動作は、オフスクリーンキャンバスに対してポインターイベントをシミュレートする統合テストで検証するのが最適です。既存のスイートについては `test/` を参照し、新しいテストのテンプレートとして使用してください。
