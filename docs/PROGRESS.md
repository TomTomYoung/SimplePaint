# プロジェクト進捗レポート

## アプリケーションの起動フロー
- `index.html` に UI 全体（ツールバー、キャンバス領域、サイドパネル、フッター）が定義されており、初期状態から複数の描画ツールやレイヤー操作ボタンが利用可能です。
- `src/main.js` で `PaintApp` を生成し、塗りつぶしやテキスト編集といったユーティリティをエクスポートしています。ロードイベントで `app.boot()` を呼び出し、アプリの初期化を開始します。
- `src/app.js` の `PaintApp` クラスは DOM マネージャー、イベントバス、ストア、ビューポート、描画エンジンを構築し、ツール登録と UI 初期化、ドキュメント生成を担当しています。

## コアシステム
- `src/core/engine.js` の `Engine` クラスはツール登録・切り替え、ヒストリースタック管理、選択範囲の蟻の行進描画、フィルタープレビュー、キャンバスのリサイズと描画などを一手に担います。
- ビューポート (`src/core/viewport.js`) はパン・ズーム情報を保持し、描画エンジンと UI のズーム表示を同期します。
- ストア (`src/core/store.js`) はツールごとの状態とグローバル設定を集中管理し、イベントバスを通じた更新通知を提供します。

## ツールエコシステム
- `src/tools/registry.js` で選択ツール、ブラシ系、水彩、ノイズ、ベクター処理、幾何ツール、テキストなど多数のツールファクトリを登録しています。
- 各ツールはストアを介して設定を取得し、エンジン API に沿った共通インターフェースで動作するため、追加や差し替えが容易な構造です。

## 入出力・セッション管理
- `src/io/index.js` はファイル読込、画像書き出し、クリップボード操作、オートセーブ（セッション保存・復元）を集約しており、状態更新時にステータスバーやボタン表示を制御します。
- ペーストイベントをハンドリングし、画像を取得して浮動選択としてキャンバスへ配置する処理や、保存失敗時のメッセージ表示など、ユーザー体験に必要な分岐が実装済みです。

## UI 全般
- 左右のサイドパネルやリサイズハンドル、ステータスバー表示、ショートカット案内など、ユーザーフィードバックを高める仕組みが `index.html` と対応する GUI モジュールで実装されています。
- `styles.css` はフレックスレイアウトでステージやパネルの配置を定義し、キャンバス領域の自動リサイズとエディターレイヤーの重ね合わせに対応しています。

## 次のステップ候補
- ツールごとの設定 UI や内部状態を `docs/` 配下にまとめ、開発者ガイドを整備すると保守性が高まります。
- `test/` ディレクトリを活用し、主要ユーティリティ（塗りつぶし、幾何計算など）の自動テストを拡充することで回帰不具合を防げます。
- オートセーブやクリップボード処理のエラーハンドリングを GUI 上で通知するためのデザイン調整も検討できます。

## 最新アップデート
- 数値ユーティリティに角度変換や循環、スムースステップ関数を追加し、描画アルゴリズムで扱う補間計算が扱いやすくなりました。
- 幾何ユーティリティに折れ線長、面積、重心計算を実装し、図形ツールの開発に必要な計算が揃いました。
- 新規テストとして数学・幾何モジュールを検証するスイートを追加し、ユーティリティ層の信頼性を高めています。
- 幾何ユーティリティに線分交差・最短距離・点内包判定を追加し、選択範囲操作やスナップ機能のロジック構築が進めやすくなりました。
- テストスイートも拡張し、新規ジオメトリ関数の境界ケースを含めて自動検証できるようにしています。
- 色空間ユーティリティに HSL 変換や sRGB 線形化関数を追加し、色調整やフィルタ機能の数値基盤を強化しました。
- 画像処理ユーティリティに畳み込み、ボックス／ガウシアンブラー、アンシャープマスクを実装し、専用テストでフィルターの正当性を確認しています。
- グレースケール変換とソーベル／プレウィット／ラプラシアンのエッジ検出フィルターを追加し、しきい値やアルファ維持の挙動も含めて自動テストで検証しました。
- ヒストグラム解析・平坦化および Otsu 法を含む二値化処理を追加し、しきい値の自動推定とカスタム配色の挙動をユニットテストで確認しました。
- 形態学的フィルター（膨張・収縮・オープニング・クロージング）を実装し、ノイズ除去やギャップ充填シナリオを網羅する自動テストを追加しました。
- Canvas ヘルパーに HiDPI 対応のリサイズ／生成処理やアスペクト比フィット計算を実装し、Node テストで DPR スケーリングや行列リセットの挙動を検証しました。
- DOM ヘルパーを新設し、要素生成・属性操作・デリゲート・フォーカストラップといった UI 構築の共通処理をまとめ、Node 向けの軽量 DOM モックでユニットテストを整備しました。
- イベントバスに `once`、AbortSignal 連動、非同期発火、リスナークエリといったユーティリティを追加し、挙動とエラーハンドリングを確認する専用テストを整えました。
- ストアに差分検出・派生ウォッチャー・ツール状態のリセット／クリア API を導入し、既存 UI への互換性を保ちつつユニットテストでスナップショットの保持と通知内容を検証しました。
- ビューポートにズーム境界設定、アンカー維持ズーム、パン制約／コンテイン処理、パディング対応フィット計算を実装し、Node テストで表示安定性とコンテイン挙動を検証しました。
- オートセーブ制御を拡張し、イベントバス連携やポーズ／リジューム、即時フラッシュ、構成更新、ディスポーズなどのライフサイクル API を追加しました。Node 向けのタイマーモックでデバウンス・インターバル動作・リスナー解放を検証する専用テストスイートを整備しています。
- 履歴マネージャーに履歴上限の動的変更、メタデータ編集、スナップショット通知リスナーを追加し、push/undo/redo/limit イベントの挙動を Node テストで検証しました。
- 色空間ユーティリティに sRGB↔XYZ、XYZ↔Lab、Lab↔LCh の相互変換と Lab/LCh ラウンドトリップ検証を追加し、厳密な色調整に必要な座標系変換をユニットテストで担保しました。
- 2D 変換ユーティリティを新設し、行列合成・逆行列・デコンポーズ・バウンディング計算・ピボット対応の回転／スケール／スキューを揃え、Node テストで順序や再構成の正当性を確認しました。
- ベジェ曲線ユーティリティを追加し、評価・分割・バウンディング計算・長さ推定を提供するとともに、ユニットテストで代表的な曲線挙動と近似精度を検証しました。
- パスユーティリティを新設し、弧長テーブル生成・距離パラメータサンプリング・等間隔リサンプリング・最近傍投影を提供、対応するテストで開／閉パスの挙動とメタデータ計算を検証しました。
- パスユーティリティに Chaikin 平滑化、Douglas–Peucker 簡略化、接線／法線ベクトル算出を追加し、スムージング回数や閉路対応、接線直交性をチェックするテストを整備しました。
- パスユーティリティに Catmull–Rom 補間サンプリングと Bézier 変換を加え、α パラメータ制御を含む補間結果とセグメント変換を自動テストで検証しました。
- パスユーティリティに一様 3 次 B-spline の評価・接線計算・サンプリング・Bézier セグメント変換を追加し、基底関数の整合性とサンプル密度をユニットテストで確認しました。
- パスユーティリティに非一様有理 B-spline の評価・接線推定・パラメータサンプリングを追加し、円弧再現と単位接線の一貫性をユニットテストで検証しました。
- ノイズユーティリティを新設し、シード付き乱数・Perlin ノイズ・フラクタル合成・タイル可能ノイズ生成を提供し、決定的な出力と値域を検証するテストスイートを追加しました。
